Параметры подключения к базе postgre:

    host: 10.4.107.88
    port: 5433
    database: username_db

1) Написать даг, который сохранит агрегации подсчета user_id из папок 
regions_random в отдельные папки по регионам, партиционированные по дате.

2) Написать даг, который в формате mapped таски будет загружать 
аггрегированные данные по регионам в таблицу Postgre с помощью copy_expert:


    cur = conn.cursor()
    copy_sql = """
               COPY table_name FROM stdin WITH CSV HEADER
               DELIMITER as ','
               """
    with open(path, 'r') as f:
        cur.copy_expert(sql=copy_sql, file=f)
        conn.commit()
        cur.close()

Для подключения использовать conn_id="postgres_data_{username}"

***

Подскажите, по какому пути нужно сохранять результирующие файлы с агрегацией? opt/airflow/data/{username}/regions_random/{region}/?

Да

***

В каком формате должно быть название таблицы table_name? в нем должны фигурировать дата и регион? или это должны быть 
колонки таблицы? нам же не нужно в задании находить общее кол-во звонков по всем регионам на определенную дату или нужно, 
и в таком случае именно его помещать в БД?

Название не важно, колонки : дата, регион, пользователь, счётчик по пользователю

***

Не понимаю, нам сначала нужно данные нагенерить себе в папку, а потом уже агрегировать? Или работать с существующими из лекции, но где они лежат?
Сложновато переварить задание с путями на сервере, когда к этому серверу нет доступа и из задания не понятно что откуда брать.

Можно взять то, что есть уже. Первый даг-агрегация и сохранение, второй - их запись в бд, я так поняла

Если руководствоваться заданием - да. А вы вычитывали данные откуда, чтобы потом агрегировать, из 
opt/airflow/data/regions_random/{регион}/{данные.csv}? Если правильно понимаю даг из лекции.

Да

***

Не понимаю, почему у меня некоторые файлы на сервере за файлы не признают))

![Screenshot_80.png](img%2FScreenshot_80.png)

у меня файлы с 1 февраля

Почему тогда январские не считаются?) У меня даг стартует 1-ого января)

Запускайте даг с февраля

Через os.path.isfile() проверяете? если файла нет, то false возвращает

Через pathlib.Path.is_file() как в лекции

Тяжело без возможности посмотреть сервер)) Что есть, что нет, где что лежит

Я запускал listdir() и выводил что лежит в папках

***

ПО второму заданию все регионы и даты в одну таблицу складываем?

Да

***

У нас во втором задании необходимо использовать copy_expert, которым мы копируем из файлов две колонки (user_id и count), 
а в постгрес нам необходимо записать уже 4 колонки (+регион и дата). Направьте, плиз, по возможным вариантам реализации ?

Можно через буффер, например

    cur = conn.cursor()
    copy_sql = """
               CREATE TEMPORARY TABLE buffer (
                    field1,
                    field2,
                    ...
                    fieldn
                );
                
                COPY buffer FROM STDIN With CSV HEADER DELIMITER as ',';
                
                INSERT INTO table(field1, field2, ... fieldn)
                SELECT field1, field2, ... fieldn FROM buffer
                ON CONFLICT (ID) DO NOTHING;
                
                DROP TABLE buffer;
               """
    with open(path, 'r') as f:
        cur.copy_expert(sql=copy_sql, file=f)
        conn.commit()
        cur.close()